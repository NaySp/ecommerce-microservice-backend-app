pipeline {
    agent any
    tools {
        jdk 'openjdk_11'
    }
    environment {
        SERVICE_NAME = 'user-service'
        DOCKER_IMAGE = "ecommerce/${SERVICE_NAME}"
        K8S_NAMESPACE = 'stage'
        STAGE_TAG = "stage-${BUILD_NUMBER}"
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Build & Test') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh './mvnw clean compile'
                    sh './mvnw test'
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                }
            }
        }
        stage('Package') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh './mvnw clean package -DskipTests'
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh """
                        # Construir la imagen dentro del runtime de Minikube (evita permisos de Docker en Jenkins)
                        minikube image build -t ${DOCKER_IMAGE}:stage-latest .
                    """
                }
            }
        }
        stage('Deploy to K8s Stage') {
            steps {
                dir(env.SERVICE_NAME) {
                    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
                        sh """
                            kubectl apply -f k8s/deployment-stage.yaml --validate=false
                            kubectl apply -f k8s/service-stage.yaml --validate=false
                            kubectl rollout status deployment/user-service -n stage --timeout=10m
                        """
                    }
                }
            }
        }
        stage('Verify Deployment') {
            steps {
                withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {
                    sh """
                        echo 'Verificando deployment en namespace ${K8S_NAMESPACE}...'
                        kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                        kubectl get svc -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                    """
                }
            }
        }
    }
    post {
        success {
            echo 'User Service desplegado correctamente en stage.'
        }
        failure {
            echo 'Pipeline de User Service (stage) fall√≥.'
        }
        always {
            echo 'Pipeline completado.'
        }
    }
}
