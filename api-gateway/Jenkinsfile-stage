pipeline {
    agent any
    tools {
        jdk 'openjdk_11'
    }
    environment {
        SERVICE_NAME = 'api-gateway'
        DOCKER_IMAGE = "ecommerce/${SERVICE_NAME}"
        K8S_NAMESPACE = 'stage'
        STAGE_TAG = "stage-${BUILD_NUMBER}"
        KUBECONFIG = '/var/jenkins_kube/jenkins-kubeconfig.yaml'
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Apply ConfigMap') {
            steps {
                sh """
                    kubectl apply -f k8s/02-configmap-staging.yaml --validate=false || true
                """
            }
        }
        stage('Build & Test') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh './mvnw clean compile'
                    sh './mvnw test'
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                }
            }
        }
        stage('Package') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh './mvnw clean package -DskipTests'
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh """
                        docker version
                        docker build -t ${DOCKER_IMAGE}:stage-latest .
                        docker save ${DOCKER_IMAGE}:stage-latest | docker exec -i minikube docker load
                    """
                }
            }
        }
        stage('Deploy to K8s Stage') {
            steps {
                dir(env.SERVICE_NAME) {
                    sh """
                        kubectl apply -f k8s/deployment-stage.yaml --validate=false
                        kubectl apply -f k8s/service-stage.yaml --validate=false
                        kubectl rollout status deployment/${SERVICE_NAME} -n stage --timeout=10m
                    """
                }
            }
        }
        stage('Verify Deployment') {
            steps {
                sh """
                    echo 'Verificando deployment en namespace ${K8S_NAMESPACE}...'
                    kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                    kubectl get svc -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                """
            }
        }
    }
    post {
        success {
            echo 'API Gateway desplegado correctamente en stage.'
        }
        failure {
            echo 'Pipeline de API Gateway (stage) fall√≥.'
        }
        always {
            echo 'Pipeline completado.'
        }
    }
}
